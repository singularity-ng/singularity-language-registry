#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: run formatting, clippy and tests inside Nix devShell if available
if command -v nix >/dev/null 2>&1; then
  echo "üîß Running pre-commit checks inside Nix devShell..."
  nix develop --command just pre-commit
else
  echo "‚ö†Ô∏è  Nix not found; running pre-commit via just (may fail if native deps missing)..."
  just pre-commit
fi

exit 0
#!/bin/bash

# Pre-commit hook for Singularity Language Registry
# Prevents committing code that doesn't meet quality standards

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo -e "${RED}‚ùå Error: Not in a Rust project root${NC}"
    exit 1
fi

# 1. Format check
echo "üìù Checking code formatting..."
if ! cargo fmt -- --check; then
    echo -e "${RED}‚ùå Code is not formatted!${NC}"
    echo -e "${YELLOW}Run 'cargo fmt' to fix formatting${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Format check passed${NC}"

# 2. Clippy check with pedantic mode
echo "üîß Running Clippy (pedantic mode)..."
if ! cargo clippy --all-targets --all-features -- -D warnings -W clippy::pedantic -W clippy::nursery 2>/dev/null; then
    echo -e "${RED}‚ùå Clippy found issues!${NC}"
    echo -e "${YELLOW}Fix the issues reported by clippy before committing${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Clippy check passed${NC}"

# 3. Build check
echo "üèóÔ∏è  Building project..."
if ! cargo build --all-features 2>/dev/null; then
    echo -e "${RED}‚ùå Build failed!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Build successful${NC}"

# 4. Test check
echo "üß™ Running tests..."
if ! cargo test --all-features --quiet; then
    echo -e "${RED}‚ùå Tests failed!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì All tests passed${NC}"

# 5. Check for sensitive data
echo "üîê Checking for sensitive data..."
SENSITIVE_PATTERNS=(
    "password"
    "secret"
    "token"
    "api[_-]?key"
    "private[_-]?key"
    "-----BEGIN"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if git diff --cached --name-only | xargs grep -iE "$pattern" 2>/dev/null; then
        echo -e "${RED}‚ùå Potential sensitive data found!${NC}"
        echo -e "${YELLOW}Please review and remove sensitive information${NC}"
        exit 1
    fi
done
echo -e "${GREEN}‚úì No sensitive data detected${NC}"

# 6. Check file size
echo "üì¶ Checking file sizes..."
MAX_SIZE=1048576 # 1MB
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
        if [ "$size" -gt "$MAX_SIZE" ]; then
            echo -e "${RED}‚ùå File $file is too large (>1MB)${NC}"
            exit 1
        fi
    fi
done
echo -e "${GREEN}‚úì File sizes OK${NC}"

# 7. Check commit message (if available)
if [ -f ".git/COMMIT_EDITMSG" ]; then
    echo "üìù Checking commit message..."
    commit_regex='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,50}'
    if ! grep -qE "$commit_regex" .git/COMMIT_EDITMSG; then
        echo -e "${YELLOW}‚ö†Ô∏è  Commit message doesn't follow conventional format${NC}"
        echo "Expected format: type(scope): description"
        echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
    fi
fi

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"