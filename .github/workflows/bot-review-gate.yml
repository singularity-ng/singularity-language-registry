# Bot Review Gate - CI check that passes when bot review has no critical issues
name: Bot Review Gate

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  # Also trigger when reviews are submitted
  pull_request_review:
    types: [submitted]

jobs:
  bot-review-gate:
    name: Bot Review
    runs-on: ubuntu-latest
    # Don't run on draft PRs
    if: github.event.pull_request.draft == false
    steps:
      - name: Wait for Gemini review
        id: wait-gemini
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request || context.payload.review?.pull_request;
            if (!pr) {
              core.setFailed('No pull request found');
              return;
            }

            const prNumber = pr.number;
            const maxAttempts = 20;  // 10 minutes max wait
            const waitInterval = 30000;  // 30 seconds

            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              console.log(`Attempt ${attempt + 1}/${maxAttempts}: Checking for Gemini review...`);

              // Get all comments on the PR
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              // Find Gemini's review comment
              const geminiComment = comments.find(c =>
                c.user?.login === 'gemini-code-assist[bot]' &&
                c.body?.includes('Summary of Changes')
              );

              if (geminiComment) {
                console.log('Found Gemini review!');

                // Check for critical/high severity issues
                const body = geminiComment.body.toLowerCase();
                const hasCritical = body.includes('critical') && body.includes('severity');
                const hasHigh = body.includes('high') && body.includes('severity');

                // Also check inline review comments
                const { data: reviewComments } = await github.rest.pulls.listReviewComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                });

                const geminiReviewComments = reviewComments.filter(c =>
                  c.user?.login === 'gemini-code-assist[bot]'
                );

                let criticalCount = 0;
                let highCount = 0;

                for (const comment of geminiReviewComments) {
                  const text = comment.body?.toLowerCase() || '';
                  if (text.includes('critical')) criticalCount++;
                  if (text.includes('high')) highCount++;
                }

                console.log(`Critical issues: ${criticalCount}, High issues: ${highCount}`);

                if (criticalCount > 0) {
                  core.setFailed(`Gemini found ${criticalCount} critical issue(s). Please address them.`);
                  return;
                }

                if (highCount > 2) {
                  core.setFailed(`Gemini found ${highCount} high severity issues. Please address some of them.`);
                  return;
                }

                console.log('✅ Bot review passed - no blocking issues found');
                core.setOutput('status', 'passed');
                return;
              }

              if (attempt < maxAttempts - 1) {
                console.log(`Waiting ${waitInterval/1000}s for Gemini review...`);
                await new Promise(r => setTimeout(r, waitInterval));
              }
            }

            // If no Gemini review after max attempts, pass anyway (don't block)
            console.log('⚠️ No Gemini review found after timeout - passing by default');
            core.setOutput('status', 'passed-no-review');

      - name: Report status
        run: |
          echo "Bot review gate completed"
          echo "Status: ${{ steps.wait-gemini.outputs.status }}"
