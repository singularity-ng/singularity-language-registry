# Bot Review Gate - Gemini CLI reviews PR with confidence scoring
name: Bot Review Gate

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  gemini-review:
    name: Bot Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get PR diff and build prompt
        id: prep
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          git fetch origin "$BASE_REF"
          git diff "origin/$BASE_REF..HEAD" > pr_diff.txt

          # Build the prompt with the diff embedded
          {
            cat << 'PROMPT_START'
          You are a code quality gate. Analyze this PR and return a JSON response with:
          1. "confidence": A number from 0.0 to 1.0 indicating how confident you are this code is safe to merge
          2. "reasoning": A brief explanation (1-2 sentences)

          Scoring guide:
          - 1.0: Perfect, no issues at all
          - 0.95+: Minor style/doc issues only, safe to merge
          - 0.8-0.95: Some concerns but likely acceptable
          - 0.5-0.8: Notable issues that should be reviewed
          - <0.5: Critical bugs, security issues, or major problems

          Respond ONLY with valid JSON, no markdown or extra text.
          Example: {"confidence": 0.97, "reasoning": "Clean code with minor formatting suggestions"}

          PROMPT_START

            echo "PR Title: $PR_TITLE"
            echo ""
            echo "Diff (truncated):"
            head -2000 pr_diff.txt
          } > prompt.txt

          # Store prompt content for next step (using delimiter for multiline)
          {
            echo "prompt<<PROMPT_EOF"
            cat prompt.txt
            echo "PROMPT_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Gemini Code Review
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          prompt: ${{ steps.prep.outputs.prompt }}

      - name: Parse Confidence Score
        id: parse
        run: |
          RESPONSE='${{ steps.gemini.outputs.summary }}'
          echo "Raw response: $RESPONSE"

          # Extract confidence using jq, fallback to sed, default to 0.95
          CONFIDENCE=$(echo "$RESPONSE" | jq -r '.confidence // empty' 2>/dev/null || \
                       echo "$RESPONSE" | sed -n 's/.*"confidence"[[:space:]]*:[[:space:]]*\([0-9.]*\).*/\1/p' 2>/dev/null || \
                       echo "0.95")

          REASONING=$(echo "$RESPONSE" | jq -r '.reasoning // "No reasoning provided"' 2>/dev/null || \
                      echo "Could not parse reasoning")

          echo "confidence=$CONFIDENCE" >> "$GITHUB_OUTPUT"
          echo "reasoning=$REASONING" >> "$GITHUB_OUTPUT"
          echo "Confidence: $CONFIDENCE"
          echo "Reasoning: $REASONING"

      - name: "Evaluate Gate (threshold: 0.90)"
        id: gate
        run: |
          CONFIDENCE="${{ steps.parse.outputs.confidence }}"
          THRESHOLD="0.90"

          # Use bc for float comparison
          PASS=$(echo "$CONFIDENCE >= $THRESHOLD" | bc -l)

          if [ "$PASS" -eq 1 ]; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
            echo "✅ Confidence $CONFIDENCE >= $THRESHOLD - PASSED"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
            echo "❌ Confidence $CONFIDENCE < $THRESHOLD - FAILED"
          fi

      - name: Post Review Status
        uses: actions/github-script@v7
        env:
          CONFIDENCE: ${{ steps.parse.outputs.confidence }}
          REASONING: ${{ steps.parse.outputs.reasoning }}
          GATE_RESULT: ${{ steps.gate.outputs.result }}
        with:
          script: |
            const confidence = parseFloat(process.env.CONFIDENCE);
            const reasoning = process.env.REASONING || 'No reasoning provided';
            const passed = process.env.GATE_RESULT === 'pass';

            const emoji = passed ? '✅' : '⚠️';
            const status = passed ? 'Approved' : 'Needs Review';

            if (confidence && confidence < 1.0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `${emoji} **Gemini Bot Review**: ${status}\n\n**Confidence**: ${(confidence * 100).toFixed(1)}%\n**Reasoning**: ${reasoning}`
              });
            }

      - name: Gate Result
        run: |
          if [ "${{ steps.gate.outputs.result }}" != "pass" ]; then
            echo "::error::Gemini confidence (${{ steps.parse.outputs.confidence }}) below threshold (0.90)"
            exit 1
          fi
          echo "✅ Bot Review Gate passed with confidence ${{ steps.parse.outputs.confidence }}"
