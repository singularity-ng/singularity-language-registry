name: Claude AI Review

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
    branches: [main]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write  # Needed for auto-merge and code changes
  pull-requests: write
  issues: write

jobs:
  # Automated review + auto-approve on PR open
  claude-review:
    name: Claude Auto Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for scope checks

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          separator: ","

      - name: Check for stale/out-of-scope files
        id: scope-check
        run: |
          echo "üîç Checking for stale files and out-of-scope changes..." > scope_check.md
          echo "" >> scope_check.md

          SCOPE_ISSUES=0

          # Get list of changed files
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"

          # Check for very old files (modified more than 2 years ago on main)
          echo "### Stale File Check" >> scope_check.md
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              # Check file age on main branch
              FILE_AGE=$(git log -1 --format="%cr" origin/main -- "$file" 2>/dev/null || echo "new file")
              FILE_DATE=$(git log -1 --format="%ci" origin/main -- "$file" 2>/dev/null || echo "")

              # Flag files older than 2 years
              if [ -n "$FILE_DATE" ]; then
                YEARS_OLD=$(( ($(date +%s) - $(date -d "$FILE_DATE" +%s)) / 31536000 ))
                if [ $YEARS_OLD -gt 2 ]; then
                  echo "‚ö†Ô∏è **WARNING**: \`$file\` is $YEARS_OLD years old (last modified: $FILE_AGE)" >> scope_check.md
                  SCOPE_ISSUES=$((SCOPE_ISSUES + 1))
                fi
              fi
            fi
          done

          if [ $SCOPE_ISSUES -eq 0 ]; then
            echo "‚úÖ No stale files detected" >> scope_check.md
          fi
          echo "" >> scope_check.md

          # Check for out-of-scope changes
          echo "### Scope Check" >> scope_check.md
          echo "Checking file relevance (blocks binaries, temp files, etc.)..." >> scope_check.md
          echo "" >> scope_check.md

          # Define in-scope patterns
          # .github/ is ALWAYS relevant (workflows, actions, templates)
          RELEVANT_PATTERNS=(
            "src/"           # Source code
            "Cargo.toml"     # Dependencies
            "tests/"         # Tests
            ".github/"       # GitHub Actions, workflows, templates - ALWAYS relevant!
            ".githooks/"     # Git hooks
            "flake.nix"      # Nix setup
            "flake.lock"     # Nix dependencies
            "README.md"      # Documentation
            "LICENSE"        # License
            "CONTRIBUTING.md" # Contribution guide
            "*.md"           # Documentation files
            "build.rs"       # Build scripts
            "examples/"      # Example code
            "justfile"       # Just commands
            ".envrc"         # Direnv setup
            "renovate.json5" # Dependency automation
          )

          # Check each changed file
          OUT_OF_SCOPE_FILES=()
          for file in $CHANGED_FILES; do
            MATCHES_PATTERN=false
            for pattern in "${RELEVANT_PATTERNS[@]}"; do
              if [[ "$file" == $pattern ]] || [[ "$file" == *"$pattern"* ]]; then
                MATCHES_PATTERN=true
                break
              fi
            done

            # Flag suspicious files
            if [ "$MATCHES_PATTERN" = false ]; then
              # Check if it's a common irrelevant file
              case "$file" in
                *.exe|*.dll|*.so|*.dylib|*.bin|*.dat|*.tmp|*.log|node_modules/*|.DS_Store|thumbs.db)
                  echo "‚ùå **OUT OF SCOPE**: \`$file\` - Binary/temp file not relevant to language registry" >> scope_check.md
                  OUT_OF_SCOPE_FILES+=("$file")
                  SCOPE_ISSUES=$((SCOPE_ISSUES + 1))
                  ;;
                *.jpg|*.png|*.gif|*.mp4|*.avi|*.mov)
                  # Allow images in docs, flag others
                  if [[ ! "$file" =~ ^docs/ ]] && [[ ! "$file" =~ ^assets/ ]]; then
                    echo "‚ö†Ô∏è **REVIEW NEEDED**: \`$file\` - Media file, ensure it's for documentation" >> scope_check.md
                  fi
                  ;;
              esac
            fi
          done

          if [ ${#OUT_OF_SCOPE_FILES[@]} -eq 0 ]; then
            echo "‚úÖ All changes appear relevant (includes .github/ workflows, src/, docs, config)" >> scope_check.md
          fi
          echo "" >> scope_check.md

          # Special note about .github/
          GITHUB_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -c "^.github/" || true)
          if [ "$GITHUB_FILES" -gt 0 ]; then
            echo "‚ÑπÔ∏è **Note**: $GITHUB_FILES .github/ file(s) changed - workflows/actions are critical infrastructure" >> scope_check.md
            echo "" >> scope_check.md
          fi

          # Save scope issues count
          echo "SCOPE_ISSUES=$SCOPE_ISSUES" >> $GITHUB_OUTPUT

          cat scope_check.md

      # Use real Claude Code Action for code review
      - name: Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY || secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            Review this PR for a Rust language registry project.

            Focus on:
            1. Rust code quality (clippy-level checks)
            2. Security vulnerabilities
            3. Test coverage
            4. Documentation completeness
            5. Whether changes are appropriate for a language registry

            Scope check results:
            $(cat scope_check.md 2>/dev/null || echo "No scope issues")

            Provide a concise review. If the code looks good, say "LGTM - auto-approving".
            If there are issues, list them clearly.
          claude_args: "--max-turns 3 --model claude-sonnet-4"

      - name: Determine auto-approve
        id: claude-analysis
        run: |
          # Check if Claude approved
          SCOPE_ISSUES=${{ steps.scope-check.outputs.SCOPE_ISSUES }}

          # For now, set based on scope check only
          # TODO: Parse Claude's actual review output
          if [ $SCOPE_ISSUES -eq 0 ]; then
            echo "AUTO_APPROVE=true" >> $GITHUB_OUTPUT
            echo "‚úÖ No scope issues detected - eligible for auto-approve"
          else
            echo "AUTO_APPROVE=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è $SCOPE_ISSUES scope issue(s) found - human review required"
          fi

      - name: Post scope check results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment_body = '## üîç Automated Checks\n\n';

            try {
              const scope_check = fs.readFileSync('scope_check.md', 'utf8');
              comment_body += scope_check;
            } catch (error) {
              comment_body += '‚úÖ Scope check passed\n';
            }

            comment_body += '\n---\n';
            comment_body += '*Claude is reviewing the code... Check the "Claude Code Review" step for detailed feedback.*\n';

            const pr_number = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: comment_body
            });

      - name: Set review status
        id: review-status
        uses: actions/github-script@v7
        env:
          AUTO_APPROVE: ${{ steps.claude-analysis.outputs.AUTO_APPROVE }}
        with:
          script: |
            const pr_number = context.payload.pull_request.number;
            const auto_approve = process.env.AUTO_APPROVE === 'true';

            // Create the review with appropriate status
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number,
              body: auto_approve
                ? '‚úÖ Claude AI approved this PR! All checks passed. Will auto-merge when CI is green.'
                : '‚ö†Ô∏è Claude AI review found issues. Human review required.',
              event: auto_approve ? 'APPROVE' : 'COMMENT'
            });

            return { auto_approve };

      - name: Enable auto-merge
        if: steps.claude-analysis.outputs.AUTO_APPROVE == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Enable auto-merge with squash strategy
          gh pr merge $PR_NUMBER --auto --squash || echo "Auto-merge may already be enabled or not allowed"

          echo "‚úÖ Auto-merge enabled! PR will merge automatically when:"
          echo "   - All required checks pass (test, lint, build)"
          echo "   - All conversations are resolved"
          echo "   - Branch is up to date with main"

  require-claude-for-main:
    name: Require Claude Review for Main
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    steps:
      - name: Check for Claude review
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = context.payload.pull_request.number;

            // Check if Claude review has been completed
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number
            });

            const has_claude_review = comments.data.some(comment =>
              comment.body.includes('Claude AI Review') ||
              comment.body.includes('Claude review completed')
            );

            if (!has_claude_review) {
              core.setFailed('‚ö†Ô∏è Claude review required for merging to main. Comment "/claude review" to trigger.');
            } else {
              console.log('‚úÖ Claude review found');
            }