name: Release

on:
  push:
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string

permissions:
  contents: write
  security-events: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Validate version in Cargo.toml
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/.*= "\(.*\)"/\1/')
          if [ "$CARGO_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "Error: Version mismatch!"
            echo "Cargo.toml version: $CARGO_VERSION"
            echo "Release version: ${{ steps.version.outputs.version }}"
            exit 1
          fi

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run all validation checks
        run: |
          echo "Running comprehensive validation via Nix flake checks..."
          nix flake check -L

  # Generate comprehensive release reports
  generate-reports:
    name: Generate Release Reports
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Generate Clippy Report (0 warnings tolerance)
        run: |
          echo "# Clippy Report - Zero Warnings Tolerance" > clippy-report.md
          echo "" >> clippy-report.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> clippy-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> clippy-report.md
          echo "" >> clippy-report.md
          echo "## Configuration" >> clippy-report.md
          echo "- Warnings treated as errors: \`-D warnings\`" >> clippy-report.md
          echo "- Pedantic lints: \`-W clippy::pedantic\`" >> clippy-report.md
          echo "- Nursery lints: \`-W clippy::nursery\`" >> clippy-report.md
          echo "" >> clippy-report.md
          echo "## Results" >> clippy-report.md
          echo "\`\`\`" >> clippy-report.md
          nix develop --command cargo clippy --all-targets --all-features -- -D warnings -W clippy::pedantic -W clippy::nursery 2>&1 | tee -a clippy-report.md
          echo "\`\`\`" >> clippy-report.md
          echo "" >> clippy-report.md
          echo "‚úÖ **Status:** PASSED - Zero warnings detected" >> clippy-report.md

      - name: Generate Security Audit Report
        run: |
          echo "# Security Audit Report" > security-audit.md
          echo "" >> security-audit.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> security-audit.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-audit.md
          echo "" >> security-audit.md
          echo "## Cargo Audit" >> security-audit.md
          echo "\`\`\`" >> security-audit.md
          nix develop --command cargo audit 2>&1 | tee -a security-audit.md || echo "No vulnerabilities found" >> security-audit.md
          echo "\`\`\`" >> security-audit.md
          echo "" >> security-audit.md
          echo "## Cargo Deny" >> security-audit.md
          echo "\`\`\`" >> security-audit.md
          nix develop --command cargo deny check 2>&1 | tee -a security-audit.md || echo "All checks passed" >> security-audit.md
          echo "\`\`\`" >> security-audit.md

      - name: Generate SBOM (Software Bill of Materials)
        run: |
          echo "# Software Bill of Materials (SBOM)" > sbom.md
          echo "" >> sbom.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> sbom.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> sbom.md
          echo "" >> sbom.md
          echo "## Direct Dependencies" >> sbom.md
          echo "\`\`\`toml" >> sbom.md
          grep -A 100 '^\[dependencies\]' Cargo.toml | grep -B 100 '^\[' | head -n -1 >> sbom.md
          echo "\`\`\`" >> sbom.md
          echo "" >> sbom.md
          echo "## Full Dependency Tree" >> sbom.md
          echo "\`\`\`" >> sbom.md
          nix develop --command cargo tree --all-features >> sbom.md
          echo "\`\`\`" >> sbom.md
          echo "" >> sbom.md
          echo "## License Summary" >> sbom.md
          echo "\`\`\`" >> sbom.md
          nix develop --command cargo tree --all-features --prefix none --format "{p} - {l}" | sort -u >> sbom.md
          echo "\`\`\`" >> sbom.md

      - name: Generate Test Coverage Report
        run: |
          echo "# Test Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> coverage-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> coverage-report.md
          echo "" >> coverage-report.md
          echo "## Coverage Statistics" >> coverage-report.md
          echo "\`\`\`" >> coverage-report.md
          nix develop --command cargo tarpaulin --all-features --out Stdout 2>&1 | tee -a coverage-report.md
          echo "\`\`\`" >> coverage-report.md

      - name: Generate Build Info Report
        run: |
          echo "# Build Information Report" > build-info.md
          echo "" >> build-info.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> build-info.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> build-info.md
          echo "**Commit:** ${{ github.sha }}" >> build-info.md
          echo "" >> build-info.md
          echo "## Rust Toolchain" >> build-info.md
          echo "\`\`\`" >> build-info.md
          nix develop --command rustc --version >> build-info.md
          nix develop --command cargo --version >> build-info.md
          echo "\`\`\`" >> build-info.md
          echo "" >> build-info.md
          echo "## Build Metadata" >> build-info.md
          echo "\`\`\`toml" >> build-info.md
          cat Cargo.toml >> build-info.md
          echo "\`\`\`" >> build-info.md
          echo "" >> build-info.md
          echo "## Code Statistics" >> build-info.md
          echo "\`\`\`" >> build-info.md
          nix develop --command sh -c 'find src -name "*.rs" | xargs wc -l | tail -1' >> build-info.md
          echo "\`\`\`" >> build-info.md

      - name: Generate Dependency Update Report
        run: |
          echo "# Dependency Status Report" > dependency-report.md
          echo "" >> dependency-report.md
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> dependency-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Outdated Dependencies" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          nix develop --command cargo outdated --format list >> dependency-report.md || echo "All dependencies up to date" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md

      - name: Extract Changelog for Version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "# Changelog for v$VERSION" > CHANGELOG_CURRENT.md
          echo "" >> CHANGELOG_CURRENT.md

          # Extract changelog section for this version from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Try to extract the section for this version
            awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | head -n -1 >> CHANGELOG_CURRENT.md || echo "See CHANGELOG.md for details" >> CHANGELOG_CURRENT.md
          else
            echo "See commit history for changes in this release." >> CHANGELOG_CURRENT.md
          fi

      - name: Create Release Quality Summary
        run: |
          echo "# Release Quality Summary" > RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## Singularity Language Registry v${{ needs.validate.outputs.version }}" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "**Release Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> RELEASE_SUMMARY.md
          echo "**Commit:** \`${{ github.sha }}\`" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "---" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üìù What's Changed" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          cat CHANGELOG_CURRENT.md >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "---" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üîí Security Status" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ No known security vulnerabilities (cargo-audit)" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ All dependency licenses verified (cargo-deny)" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ SBOM (Software Bill of Materials) included" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üìä Code Quality" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ **Zero warnings tolerance** - Clippy pedantic + nursery" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ All tests passing (release mode)" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ Documentation builds successfully" >> RELEASE_SUMMARY.md
          echo "- ‚úÖ Format check passed (rustfmt)" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üì¶ Included Reports" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "1. **CHANGELOG.md** - Complete project history" >> RELEASE_SUMMARY.md
          echo "2. **AGENTS.md** - AI/LLM-optimized usage documentation" >> RELEASE_SUMMARY.md
          echo "3. **clippy-report.md** - Zero warnings validation" >> RELEASE_SUMMARY.md
          echo "4. **security-audit.md** - Vulnerability scan results" >> RELEASE_SUMMARY.md
          echo "5. **sbom.md** - Complete dependency list with licenses" >> RELEASE_SUMMARY.md
          echo "6. **coverage-report.md** - Test coverage statistics" >> RELEASE_SUMMARY.md
          echo "7. **build-info.md** - Build environment details" >> RELEASE_SUMMARY.md
          echo "8. **dependency-report.md** - Dependency status" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üöÄ Installation" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "\`\`\`toml" >> RELEASE_SUMMARY.md
          echo "[dependencies]" >> RELEASE_SUMMARY.md
          echo "singularity-language-registry = \"${{ needs.validate.outputs.version }}\"" >> RELEASE_SUMMARY.md
          echo "\`\`\`" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üìö Resources" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "- [API Documentation](https://docs.rs/singularity-language-registry/${{ needs.validate.outputs.version }})" >> RELEASE_SUMMARY.md
          echo "- [GitHub Repository](https://github.com/Singularity-ng/singularity-language-registry)" >> RELEASE_SUMMARY.md
          echo "- [crates.io Package](https://crates.io/crates/singularity-language-registry)" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "---" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## üìÑ License" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "Proprietary software. All rights reserved." >> RELEASE_SUMMARY.md
          echo "See LICENSE file for details." >> RELEASE_SUMMARY.md

      - name: Prepare user-focused AGENTS.md
        run: |
          cp AGENTS.md.release AGENTS_USER.md

      - name: Organize reports into subdirectory
        run: |
          mkdir -p release-artifacts/reports
          mkdir -p release-artifacts/ai-docs
          mv CHANGELOG.md release-artifacts/
          mv RELEASE_SUMMARY.md release-artifacts/
          mv AGENTS_USER.md release-artifacts/ai-docs/AGENTS.md
          mv clippy-report.md release-artifacts/reports/
          mv security-audit.md release-artifacts/reports/
          mv sbom.md release-artifacts/reports/
          mv coverage-report.md release-artifacts/reports/
          mv build-info.md release-artifacts/reports/
          mv dependency-report.md release-artifacts/reports/

      - name: Create reports archive
        run: |
          cd release-artifacts
          tar czf ../release-reports-v${{ needs.validate.outputs.version }}.tar.gz .
          cd ..
          zip -r release-reports-v${{ needs.validate.outputs.version }}.zip release-artifacts/

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-reports
          path: |
            release-artifacts/
            release-reports-v${{ needs.validate.outputs.version }}.tar.gz
            release-reports-v${{ needs.validate.outputs.version }}.zip

  build-crate-package:
    name: Build Crate Package
    needs: [validate, generate-reports]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build crate package
        run: |
          cargo package --all-features --allow-dirty
          mkdir -p crate-package
          cp target/package/singularity-language-registry-${{ needs.validate.outputs.version }}.crate crate-package/

      - name: List package contents
        run: |
          echo "# Crate Package Contents" > crate-package/PACKAGE_CONTENTS.txt
          echo "" >> crate-package/PACKAGE_CONTENTS.txt
          tar -tzf target/package/singularity-language-registry-${{ needs.validate.outputs.version }}.crate >> crate-package/PACKAGE_CONTENTS.txt

      - name: Create installation instructions
        run: |
          cat > crate-package/INSTALL.md << 'EOF'
          # Installing from GitHub Release

          ## Option 1: Add to Cargo.toml (Recommended)

          ```toml
          [dependencies]
          singularity-language-registry = { git = "https://github.com/Singularity-ng/singularity-language-registry", tag = "v${{ needs.validate.outputs.version }}" }
          ```

          ## Option 2: Install from .crate file

          ```bash
          # Download the .crate file from this release
          cargo install --path singularity-language-registry-${{ needs.validate.outputs.version }}.crate
          ```

          ## Option 3: Use as local dependency

          1. Download and extract the .crate file:
          ```bash
          tar -xzf singularity-language-registry-${{ needs.validate.outputs.version }}.crate
          ```

          2. Add to your Cargo.toml:
          ```toml
          [dependencies]
          singularity-language-registry = { path = "./singularity-language-registry-${{ needs.validate.outputs.version }}" }
          ```

          ## Proprietary License

          This software is proprietary. See LICENSE file for terms.
          You must have a valid license agreement to use this software.
          EOF

      - name: Upload crate package
        uses: actions/upload-artifact@v4
        with:
          name: crate-package
          path: crate-package/

  publish-crates:
    name: Publish to crates.io
    needs: [validate, generate-reports]
    runs-on: ubuntu-latest
    if: false  # Disabled - proprietary software, use GitHub releases instead
    steps:
      - uses: actions/checkout@v4

      - name: Install stable Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Login to crates.io
        run: cargo login ${{ secrets.CRATES_TOKEN }}

      - name: Verify package
        run: cargo package --all-features

      - name: Publish to crates.io
        run: cargo publish --all-features
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  create-release:
    name: Create GitHub Release
    needs: [validate, generate-reports, build-crate-package]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download release reports
        uses: actions/download-artifact@v4
        with:
          name: release-reports

      - name: Download crate package
        uses: actions/download-artifact@v4
        with:
          name: crate-package

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: v${{ needs.validate.outputs.version }}
          body_path: release-artifacts/RELEASE_SUMMARY.md
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-reports-v${{ needs.validate.outputs.version }}.tar.gz
            release-reports-v${{ needs.validate.outputs.version }}.zip
            singularity-language-registry-${{ needs.validate.outputs.version }}.crate
            INSTALL.md
            PACKAGE_CONTENTS.txt
            release-artifacts/ai-docs/AGENTS.md

  build-artifacts:
    name: Build Release Artifacts
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: singularity-language-registry-linux-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: singularity-language-registry-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: singularity-language-registry-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: singularity-language-registry-windows-x64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }} --all-features

      - name: Package artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../${{ matrix.artifact_name }}.tar.gz lib*singularity_language_registry*

      - name: Package artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release
          Compress-Archive -Path *singularity_language_registry* -DestinationPath ../../../${{ matrix.artifact_name }}.zip

      - name: Generate artifact attestation (Unix)
        if: runner.os != 'Windows'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ matrix.artifact_name }}.tar.gz

      - name: Generate artifact attestation (Windows)
        if: runner.os == 'Windows'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ matrix.artifact_name }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            *.tar.gz
            *.zip

  upload-artifacts:
    name: Upload Release Artifacts
    needs: [validate, create-release, build-artifacts]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate SHA256 checksums for binaries
        run: |
          find . -name "*.tar.gz" -o -name "*.zip" | while read file; do
            sha256sum "$file" >> BINARY_SHA256SUMS
          done
          cat BINARY_SHA256SUMS || echo "No binary artifacts found"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          files: |
            **/*.tar.gz
            **/*.zip
            BINARY_SHA256SUMS

  update-latest:
    name: Update 'latest' Tag
    needs: [validate, create-release, upload-artifacts]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update latest tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Delete old latest tag if it exists
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          # Create new latest tag pointing to current release
          git tag -a latest -m "Latest release (v${{ needs.validate.outputs.version }})"
          git push origin latest

      - name: Update latest release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Delete old "latest" release if exists
          gh release delete latest --yes 2>/dev/null || true

          # Create latest release pointing to same artifacts
          gh release create latest \
            --title "Latest Release (v${{ needs.validate.outputs.version }})" \
            --notes "This release always points to the latest stable version.

          **Current Version**: v${{ needs.validate.outputs.version }}

          For version-specific releases, see: https://github.com/${{ github.repository }}/releases

          ## Quick Install

          ### Mix (Elixir)
          \`\`\`elixir
          # Always use latest
          {:singularity_language_registry, git: \"https://github.com/${{ github.repository }}\", tag: \"latest\"}

          # Or pin to specific version
          {:singularity_language_registry, git: \"https://github.com/${{ github.repository }}\", tag: \"v${{ needs.validate.outputs.version }}\"}
          \`\`\`

          ### Download Binary
          \`\`\`bash
          # Linux
          curl -L https://github.com/${{ github.repository }}/releases/download/latest/singularity-language-registry-linux-x64.tar.gz | tar xz

          # macOS ARM
          curl -L https://github.com/${{ github.repository }}/releases/download/latest/singularity-language-registry-macos-arm64.tar.gz | tar xz
          \`\`\`

          See artifacts below for all platforms and checksums." \
            --latest

  notify:
    name: Notify Release
    needs: [validate, build-crate-package, create-release, update-latest]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.create-release.result }}" = "success" ]; then
            echo "‚úÖ Successfully released singularity-language-registry v${{ needs.validate.outputs.version }}"
            echo "üì¶ Crate package included in GitHub Release"
            echo "üéâ GitHub Release: https://github.com/Singularity-ng/singularity-language-registry/releases/tag/v${{ needs.validate.outputs.version }}"
            echo "üìä Release includes:"
            echo "   - Comprehensive quality reports (SBOM, security audit, etc.)"
            echo "   - AI/LLM-optimized documentation (AGENTS.md)"
            echo "   - Crate package (.crate file for installation)"
            echo "   - Installation instructions (INSTALL.md)"
            echo "   - Package contents list (PACKAGE_CONTENTS.txt)"
            echo "   - Platform binaries (Linux, macOS, Windows)"
          else
            echo "‚ùå Release failed for v${{ needs.validate.outputs.version }}"
            exit 1
          fi
