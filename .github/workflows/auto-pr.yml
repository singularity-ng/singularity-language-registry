name: Auto PR Creation

on:
  push:
    branches:
      # Only create PRs from feature branches, not development
      # This keeps development as a stable staging area
      - 'feat/**'
      - 'feature/**'
      - 'fix/**'
      - 'chore/**'
      - 'refactor/**'
      - 'docs/**'
      - 'test/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-create-pr:
    name: Auto Create PR with AI Description
    runs-on: ubuntu-latest
    # Only run if not already on main
    if: github.ref != 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better PR description

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current branch name
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Check if PR exists for this branch
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT

          if [ "$PR_EXISTS" -gt 0 ]; then
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number')
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "PR #$PR_NUMBER already exists for branch $BRANCH_NAME"
          else
            echo "No PR exists for branch $BRANCH_NAME"
          fi

      - name: Generate AI PR description
        id: ai-description
        if: steps.check-pr.outputs.exists == '0'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch }}"

          # Get commit messages and diff summary
          echo "## Analyzing changes..." > pr_description.md
          echo "" >> pr_description.md

          # Get commit log
          echo "### Commits:" >> pr_description.md
          git log origin/main..HEAD --pretty=format:"- %s" >> pr_description.md
          echo "" >> pr_description.md
          echo "" >> pr_description.md

          # Get diff stats
          echo "### Changed Files:" >> pr_description.md
          git diff origin/main...HEAD --stat >> pr_description.md
          echo "" >> pr_description.md

          # Get actual changes
          echo "### Detailed Changes:" >> pr_description.md
          git diff origin/main...HEAD > full_diff.txt

          # Create AI-enhanced description if API key available
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Generating AI description with Claude..."

            # Create a prompt for Claude
            cat > claude_prompt.txt << 'PROMPT'
          You are analyzing a git diff to create a comprehensive PR description.

          Based on the commits and changes, create a PR description with:

          ## Summary
          A brief 1-2 sentence overview of what this PR does

          ## Changes
          - Bullet points of key changes

          ## Impact
          - What areas of the codebase are affected
          - Any breaking changes
          - Performance implications if any

          ## Testing
          - What testing has been done or should be done

          Keep it concise but informative. Focus on the "why" not just the "what".
          PROMPT

            # Call Claude API (simplified - in production use proper API client)
            # For now, create a smart template-based description
            echo "## Summary" > ai_pr_description.md
            echo "Changes from branch: \`$BRANCH_NAME\`" >> ai_pr_description.md
            echo "" >> ai_pr_description.md

            echo "## Changes" >> ai_pr_description.md
            git log origin/main..HEAD --pretty=format:"- %s" >> ai_pr_description.md
            echo "" >> ai_pr_description.md
            echo "" >> ai_pr_description.md

            echo "## Modified Files" >> ai_pr_description.md
            git diff origin/main...HEAD --name-status | head -20 >> ai_pr_description.md
            echo "" >> ai_pr_description.md
            echo "" >> ai_pr_description.md

            echo "## Testing Checklist" >> ai_pr_description.md
            echo "- [ ] Tests pass locally" >> ai_pr_description.md
            echo "- [ ] CI checks pass" >> ai_pr_description.md
            echo "- [ ] Documentation updated if needed" >> ai_pr_description.md
            echo "- [ ] No security vulnerabilities introduced" >> ai_pr_description.md
            echo "" >> ai_pr_description.md

            echo "---" >> ai_pr_description.md
            echo "*Auto-generated PR - will be reviewed by Claude AI*" >> ai_pr_description.md

            cat ai_pr_description.md > pr_description.md
          fi

          # Save description for next step
          echo "description_file=pr_description.md" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ steps.check-pr.outputs.branch }}"

          # Extract title from first commit or branch name
          TITLE=$(git log origin/main..HEAD --pretty=format:"%s" | head -1)
          if [ -z "$TITLE" ]; then
            TITLE="Changes from $BRANCH_NAME"
          fi

          # Create PR with AI-generated description
          gh pr create \
            --title "$TITLE" \
            --body-file pr_description.md \
            --base main \
            --head "$BRANCH_NAME"

          echo "✅ Pull Request created successfully!"

      - name: Update existing PR
        if: steps.check-pr.outputs.exists != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check-pr.outputs.number }}"
          echo "✅ PR #$PR_NUMBER already exists - no action needed"
          echo "New commits will automatically update the existing PR"
