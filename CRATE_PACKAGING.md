# Crate Packaging - What's Included in crates.io Release

## Summary

When you run `cargo publish`, only **essential user-facing files** are included in the crate package.
Development infrastructure, CI/CD configs, and internal documentation are excluded.

---

## ✅ INCLUDED in crates.io Package

These files ARE shipped to users who install via `cargo add`:

### Source Code & Tests
```
src/                    # Library source code
tests/                  # Integration tests (optional for users)
examples/               # Usage examples
benches/                # Benchmarks (optional)
```

### Essential Documentation
```
README.md               # User-facing documentation
LICENSE                 # Proprietary license terms
CHANGELOG.md            # Project history
CONTRIBUTING.md         # How to contribute
```

### Build Configuration
```
Cargo.toml              # Package metadata & dependencies
Cargo.lock              # Dependency lock file (if present)
build.rs                # Build script (if present)
```

### API Documentation
```
RELEASE_PROCESS.md      # How releases work (useful for contributors)
```

**Total size:** ~50-100 KB (mostly source code)

---

## ❌ EXCLUDED from crates.io Package

These files stay in GitHub, NOT shipped to crates.io:

### CI/CD Infrastructure
```
.github/                # GitHub Actions workflows
  ├── workflows/        # CI/CD pipelines
  ├── branch-protection.md
  ├── CACHE_SETUP.md
  └── enterprise-config.md
```

**Why:** Users don't need your CI setup to use the library.

### Nix Development Environment
```
flake.nix               # Nix package definition
flake.lock              # Nix dependency lock
.envrc                  # direnv configuration
.envrc.local            # Local secrets (gitignored anyway)
.envrc.local.example    # Template for secrets
.direnv/                # direnv cache (gitignored)
result                  # Nix build output (gitignored)
result-*                # Nix build outputs (gitignored)
```

**Why:** Users install via cargo, not Nix. Nix is for contributors only.

### Development Tooling
```
justfile                # Task runner commands
setup-hooks.sh          # Git hooks setup script
.git-hooks/             # Git hooks
```

**Why:** These are for contributors, not library users.

### Build Artifacts
```
release-reports/        # Locally generated reports
target/                 # Cargo build cache (gitignored)
*.profraw              # Coverage data (gitignored)
*.profdata             # Coverage data (gitignored)
```

**Why:** Temporary build files, regenerated by users.

### Internal Documentation
```
DOCS_SETUP.md           # How to setup documentation infrastructure
WORKFLOWS_SETUP.md      # How to setup GitHub workflows
AUTO_MERGE_FLOW.md      # Auto-merge configuration
GITHUB_SETUP_COMPLETE.md # GitHub setup guide
RENOVATE.md             # Renovate bot configuration
FLAKEHUB_SETUP.md       # FlakeHub setup
PRIVATE_CRATES.md       # Private crate publishing
CACHE_SETUP.md          # Cache configuration
CARGO_TOOLS.md          # Tool analysis (dev/CI/prod)
REFACTORING_SUMMARY.md  # CI refactoring notes
RELEASE_REPORTS_SUMMARY.md # Report generation docs
COMPLETE_SUMMARY.md     # Implementation summary
```

**Why:** Internal project documentation, not relevant to library users.

### IDE & OS Files
```
.vscode/                # VS Code settings
.idea/                  # IntelliJ settings
*.swp, *.swo           # Vim swap files
.DS_Store              # macOS metadata
Thumbs.db              # Windows metadata
```

**Why:** Personal IDE configs and OS files.

---

## How It Works

### 1. Cargo Default Behavior

By default, `cargo publish`:
- ✅ Includes everything tracked by git
- ❌ Excludes `.gitignore` patterns
- ❌ Excludes `.git/` directory

### 2. Our Custom Exclusions

We added `exclude` in `Cargo.toml` to also remove:
- Development infrastructure (Nix, CI/CD)
- Internal documentation
- Development tooling

### 3. Verification

Before publishing, verify what gets included:

```bash
# Package the crate (creates .crate file)
cargo package

# List contents
tar -tzf target/package/singularity-language-registry-0.1.0.crate

# Extract and inspect
tar -xzf target/package/singularity-language-registry-0.1.0.crate -C /tmp
ls -lah /tmp/singularity-language-registry-0.1.0/
```

Expected output:
```
/tmp/singularity-language-registry-0.1.0/
├── Cargo.toml
├── Cargo.toml.orig      # Original before cargo modifications
├── README.md
├── LICENSE
├── CHANGELOG.md
├── CONTRIBUTING.md
├── RELEASE_PROCESS.md
├── src/
│   ├── lib.rs
│   └── ...
├── tests/
│   └── ...
└── examples/
    └── ...
```

---

## File Size Comparison

### Full Git Repository
```
Total:        ~5-10 MB
├── Source:   ~100 KB
├── Docs:     ~500 KB
├── CI/CD:    ~50 KB
├── Nix:      ~50 KB
└── .git:     ~4-9 MB (history)
```

### crates.io Package
```
Total:        ~50-100 KB
├── Source:   ~80 KB
├── Docs:     ~20 KB
└── Config:   ~5 KB
```

**Result:** 98% smaller! Users only download what they need.

---

## What Users Get

### When installing via cargo:

```bash
cargo add singularity-language-registry
```

**Users receive:**
1. Compiled library (rlib)
2. API documentation on docs.rs
3. README on crates.io
4. LICENSE terms
5. CHANGELOG history

**Users DON'T receive:**
- Your CI/CD workflows
- Nix development setup
- Internal documentation
- Development scripts
- Git history

---

## What's on GitHub Release

GitHub releases (created by `.github/workflows/release.yml`) include:

### Release Page Shows:
- RELEASE_SUMMARY.md (as description)
- Auto-generated release notes from commits

### Downloadable Assets:
1. **Quality Reports (8 files)**
   - CHANGELOG.md
   - RELEASE_SUMMARY.md
   - clippy-report.md
   - security-audit.md
   - sbom.md
   - coverage-report.md
   - build-info.md
   - dependency-report.md

2. **Source Archives (2 files)**
   - singularity-language-registry-v0.1.0.tar.gz (full source)
   - singularity-language-registry-v0.1.0.zip (full source)

3. **Compiled Binaries (4 files)** *(library, not needed for most users)*
   - singularity-language-registry-linux-x64.tar.gz
   - singularity-language-registry-macos-x64.tar.gz
   - singularity-language-registry-macos-arm64.tar.gz
   - singularity-language-registry-windows-x64.zip

**Note:** GitHub source archives include ALL files (even excluded ones).
Only crates.io package respects exclude rules.

---

## Three Different Distributions

### 1. crates.io Package (via `cargo publish`)
- **Audience:** Rust developers using cargo
- **Size:** ~50-100 KB
- **Contents:** Source + essential docs
- **Excludes:** CI, Nix, internal docs

### 2. GitHub Release (via release workflow)
- **Audience:** Anyone browsing releases
- **Size:** Full source + reports + binaries
- **Contents:** Everything + quality reports
- **Excludes:** Nothing (full snapshot)

### 3. Git Repository (via `git clone`)
- **Audience:** Contributors
- **Size:** Full history + development files
- **Contents:** Everything + .git history
- **Excludes:** Build artifacts (gitignored)

---

## Recommendations

### For Most Users → crates.io
```bash
cargo add singularity-language-registry
```
- Smallest download
- Only what's needed
- Automatic dependency resolution

### For Auditors → GitHub Release
- Download quality reports
- SBOM for license compliance
- Security audit results
- Complete source snapshot

### For Contributors → Git Clone
```bash
git clone https://github.com/Singularity-ng/singularity-language-registry.git
nix develop  # Get full dev environment
```
- Full history
- Development tooling
- CI/CD configs
- Nix environment

---

## Verify Before Publishing

Always check what gets packaged:

```bash
# 1. Create package
cargo package --list

# 2. Review the list - should NOT include:
#    - .github/
#    - flake.nix
#    - justfile
#    - *_SETUP.md files
#    - etc.

# 3. If looks good, publish
cargo publish --dry-run  # Test run first
cargo publish            # Actual publish
```

---

## Summary

| File Type | GitHub Repo | GitHub Release | crates.io |
|-----------|-------------|----------------|-----------|
| Source code | ✅ | ✅ | ✅ |
| Tests/Examples | ✅ | ✅ | ✅ |
| README/LICENSE | ✅ | ✅ | ✅ |
| CHANGELOG | ✅ | ✅ | ✅ |
| CONTRIBUTING | ✅ | ✅ | ✅ |
| RELEASE_PROCESS | ✅ | ✅ | ✅ |
| CI/CD configs | ✅ | ✅ | ❌ |
| Nix files | ✅ | ✅ | ❌ |
| Development tools | ✅ | ✅ | ❌ |
| Internal docs | ✅ | ✅ | ❌ |
| Quality reports | ❌ | ✅ | ❌ |
| Compiled binaries | ❌ | ✅ | ❌ |
| .git history | ✅ | ❌ | ❌ |

**Key Point:** crates.io gets the cleanest, smallest, user-focused package.
